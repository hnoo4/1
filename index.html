<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>è€é›æ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto+Mono:wght@700&display=swap');
      
      body {
        font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
        background-color: #0f172a;
        color: #e2e8f0;
        -webkit-tap-highlight-color: transparent;
      }

      .font-mono { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
      .font-keypad { font-family: system-ui, -apple-system, sans-serif; }

      .safe-area-pt { padding-top: env(safe-area-inset-top); }
      .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
      
      #modal-content {
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        will-change: transform;
      }
      
      .active-scale:active { transform: scale(0.95); }
      * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
      button:active { opacity: 0.7; }

      .drag-handle {
        width: 40px;
        height: 5px;
        background-color: #475569;
        border-radius: 999px;
        margin: 0 auto 12px;
      }

      #modal-overlay {
        transition: opacity 0.3s ease;
      }
    </style>
</head>
<body class="safe-area-pt min-h-screen">

    <header class="bg-indigo-900/40 border-b border-indigo-500/20 p-5 rounded-b-[2.5rem] shadow-2xl sticky top-0 z-20 backdrop-blur-lg">
        <div class="max-w-xl mx-auto">
            <div class="flex justify-between items-center mb-5 px-1">
                <h1 class="text-xl font-black flex items-center gap-2 text-white">
                    <span class="bg-indigo-600 p-2 rounded-xl shadow-lg"><i class="fas fa-taxi"></i></span>
                    è€é›æ°
                </h1>
                <div class="text-right">
                    <p class="text-[11px] text-slate-300 font-bold uppercase tracking-widest">ç¸½å¯¦é ˜æ·¨åˆ©</p>
                    <p id="total-net" class="text-3xl font-black font-mono text-yellow-400 drop-shadow-[0_0_15px_rgba(250,204,21,0.4)]">$0</p>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-slate-800/60 backdrop-blur-md border border-white/5 rounded-3xl py-4 flex flex-col items-center justify-center shadow-lg">
                    <i class="fas fa-dollar-sign text-green-400 text-lg mb-1"></i>
                    <span class="text-xs font-bold text-slate-300">ç¸½å¯¦é ˜</span>
                    <span id="stat-total" class="text-lg font-mono font-bold">$0</span>
                </div>
                <div class="bg-slate-800/60 backdrop-blur-md border border-white/5 rounded-3xl py-4 flex flex-col items-center justify-center shadow-lg">
                    <i class="fas fa-route text-indigo-400 text-lg mb-1"></i>
                    <span class="text-xs font-bold text-slate-300">è¶Ÿæ•¸</span>
                    <span id="stat-trips" class="text-lg font-mono font-bold">0</span>
                </div>
                <div class="bg-slate-800/60 backdrop-blur-md border border-white/5 rounded-3xl py-4 flex flex-col items-center justify-center shadow-lg">
                    <i class="fas fa-chart-line text-orange-400 text-lg mb-1"></i>
                    <span class="text-xs font-bold text-slate-300">å¹³å‡</span>
                    <span id="stat-avg" class="text-lg font-mono font-bold">$0</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto w-full pb-20">
        <div class="p-5 grid grid-cols-2 gap-4">
            <button onclick="openInput('Uber', 0.75, 'ğŸš—', 'net')" class="active-scale bg-slate-800/40 border border-slate-700/50 p-5 rounded-[2rem] flex flex-col items-center justify-center">
                <div class="w-14 h-14 bg-black rounded-2xl flex items-center justify-center mb-3 shadow-lg text-3xl">ğŸš—</div>
                <p class="text-base font-bold text-white mb-1">Uber</p>
                <p class="text-xs font-medium text-slate-500 bg-slate-900/50 px-2 py-0.5 rounded-full">è¼¸å…¥å¯¦é ˜ (75%)</p>
            </button>
            <button onclick="openInput('Bolt', 0.80, 'âš¡', 'orig')" class="active-scale bg-slate-800/40 border border-slate-700/50 p-5 rounded-[2rem] flex flex-col items-center justify-center">
                <div class="w-14 h-14 bg-green-600 rounded-2xl flex items-center justify-center mb-3 shadow-lg text-3xl">âš¡</div>
                <p class="text-base font-bold text-white mb-1">Bolt</p>
                <p class="text-xs font-medium text-slate-500 bg-slate-900/50 px-2 py-0.5 rounded-full">è¼¸å…¥åŸå§‹ (80%)</p>
            </button>
            <button onclick="openInput('å°ç£å¤§è»ŠéšŠ', 0.85, 'ğŸš•', 'orig')" class="active-scale bg-slate-800/40 border border-slate-700/50 p-5 rounded-[2rem] flex flex-col items-center justify-center">
                <div class="w-14 h-14 bg-yellow-500 rounded-2xl flex items-center justify-center mb-3 shadow-lg text-3xl">ğŸš•</div>
                <p class="text-base font-bold text-white mb-1">å°ç£å¤§è»ŠéšŠ</p>
                <p class="text-xs font-medium text-slate-500 bg-slate-900/50 px-2 py-0.5 rounded-full">è¼¸å…¥åŸå§‹ (85%)</p>
            </button>
            <button onclick="openInput('çå‹µ', 1.0, 'ğŸ', 'net')" class="active-scale bg-slate-800/40 border border-slate-700/50 p-5 rounded-[2rem] flex flex-col items-center justify-center">
                <div class="w-14 h-14 bg-red-500 rounded-2xl flex items-center justify-center mb-3 shadow-lg text-3xl">ğŸ</div>
                <p class="text-base font-bold text-white mb-1">çå‹µ/å…¶ä»–</p>
                <p class="text-xs font-medium text-slate-500 bg-slate-900/50 px-2 py-0.5 rounded-full">100% å¯¦é ˜</p>
            </button>
        </div>

        <div class="bg-slate-900/50 rounded-t-[3rem] border-t border-slate-800 shadow-inner mt-4">
            <div class="px-8 py-5 flex justify-between items-center">
                <h2 class="text-base font-black uppercase tracking-widest text-slate-400">æœ€è¿‘è¡Œç¨‹æ˜ç´°</h2>
                <button onclick="window.clearHistory()" class="text-xs font-bold text-slate-600 hover:text-red-400 transition-colors py-1 px-3 border border-slate-800 rounded-full">
                    <i class="fas fa-trash-arrow-up mr-1"></i>é•·æŒ‰æ¸…ç©º
                </button>
            </div>
            <div id="record-list" class="px-5 pb-10 space-y-3"></div>
        </div>
    </main>

    <div id="modal-overlay" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden flex flex-col justify-end" onclick="closeModal()">
        
        <div id="modal-content" class="bg-slate-800 rounded-t-[3rem] shadow-2xl border-t border-indigo-500/20 safe-area-pb max-w-xl mx-auto w-full" onclick="event.stopPropagation()">
            
            <div class="pt-3 pb-1 cursor-grab active:cursor-grabbing">
                <div class="drag-handle"></div>
            </div>

            <div class="px-6 pb-2 text-center">
                <div class="flex items-center justify-center gap-2 mb-1">
                    <span id="m-icon" class="text-2xl">ğŸš—</span>
                    <h3 id="m-title" class="text-slate-400 text-xs font-black uppercase tracking-widest">è¼¸å…¥é‡‘é¡</h3>
                </div>
                <div class="text-6xl font-black font-mono text-green-400 h-16 flex items-center justify-center tracking-tighter">
                    <span class="text-green-500 mr-2 text-3xl">$</span>
                    <span id="display-val">0</span>
                    <span class="w-1.5 h-10 bg-green-500 ml-2 animate-pulse rounded-full"></span>
                </div>
                <div class="bg-slate-900/50 border border-white/5 rounded-2xl py-1 px-4 inline-block mt-2">
                    <p class="text-sm font-bold text-slate-400 flex items-center gap-2">
                        <span id="m-calc-label">è¨ˆç®—çµæœ</span>: <span id="m-calc-val" class="text-white text-lg font-mono">$0</span>
                    </p>
                </div>
            </div>

            <div class="p-3 grid grid-cols-3 gap-2 bg-slate-900/50">
                <button onclick="pressKey('1')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">1</button>
                <button onclick="pressKey('2')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">2</button>
                <button onclick="pressKey('3')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">3</button>
                <button onclick="pressKey('4')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">4</button>
                <button onclick="pressKey('5')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">5</button>
                <button onclick="pressKey('6')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">6</button>
                <button onclick="pressKey('7')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">7</button>
                <button onclick="pressKey('8')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">8</button>
                <button onclick="pressKey('9')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">9</button>
                <button onclick="closeModal()" class="h-11 rounded-2xl bg-slate-800/50 text-slate-400 text-sm font-bold active-scale">å–æ¶ˆ</button>
                <button onclick="pressKey('0')" class="h-11 rounded-2xl bg-slate-800 text-white text-2xl font-black font-keypad border border-white/5 active-scale">0</button>
                <button onclick="pressKey('del')" class="h-11 rounded-2xl bg-slate-800/50 text-slate-400 text-xl border border-white/5 active-scale"><i class="fas fa-backspace"></i></button>
            </div>
            <div class="p-4">
                <button onclick="confirmEntry()" class="w-full h-12 bg-indigo-600 text-white text-lg font-black rounded-2xl shadow-xl active-scale flex items-center justify-center gap-3">
                    ç¢ºèªå…¥å¸³ <i class="fas fa-check-circle"></i>
                </button>
            </div>
            <div class="h-4"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'taxi_ledger_final_v5';
        let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let currentInput = "";
        let currentTemplate = null;

        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        const modalContent = document.getElementById('modal-content');
        const modalOverlay = document.getElementById('modal-overlay');

        function init() { 
            updateUI(); 
            initGesture();
        }

        // ä¿®æ”¹ï¼šç›£è½å€åŸŸæ”¹ç‚º modalContentï¼Œè®“æ•´å€‹å½ˆçª—éƒ½å¯æ‹–æ›³
        function initGesture() {
            const dragZone = document.getElementById('modal-content');

            const onTouchStart = (e) => {
                // æª¢æŸ¥æ˜¯å¦é»æ“Šåˆ°æŒ‰éˆ• (é¿å…æ‹–æ›³å½±éŸ¿é»æ“Š)
                // ä½†ç‚ºäº†å¯¦ç¾ã€ŒæŒ‰ä½æŒ‰éˆ•ä¸‹æ‹‰ä¹Ÿèƒ½é—œé–‰ã€ï¼Œæˆ‘å€‘ä¸åšéå¤šé˜»æ“‹
                // ç€è¦½å™¨é€šå¸¸èƒ½å€åˆ† Click å’Œ Scroll/Drag
                startY = e.touches[0].clientY;
                isDragging = true;
                modalContent.style.transition = 'none'; 
            };

            const onTouchMove = (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                
                if (deltaY > 0) { 
                    e.preventDefault(); // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
                    modalContent.style.transform = `translateY(${deltaY}px)`;
                    const opacity = 0.7 * (1 - deltaY / window.innerHeight);
                    modalOverlay.style.backgroundColor = `rgba(0, 0, 0, ${Math.max(0, opacity)})`;
                }
            };

            const onTouchEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                const deltaY = currentY - startY;
                const threshold = window.innerHeight * 0.4; 

                modalContent.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                
                if (deltaY > threshold) {
                    closeModal();
                } else {
                    modalContent.style.transform = `translateY(0)`;
                    modalOverlay.style.backgroundColor = `rgba(0, 0, 0, 0.7)`;
                }
                currentY = 0;
            };

            dragZone.addEventListener('touchstart', onTouchStart);
            window.addEventListener('touchmove', onTouchMove, { passive: false });
            window.addEventListener('touchend', onTouchEnd);
        }

        window.openInput = function(label, rate, icon, inputType) {
            currentTemplate = { label, rate, icon, inputType };
            currentInput = "";
            document.getElementById('m-title').innerText = inputType === 'net' ? `${label} å¯¦é ˜é‡‘é¡` : `${label} åŸå§‹è»Šè³‡`;
            document.getElementById('m-icon').innerText = icon;
            document.getElementById('m-calc-label').innerText = inputType === 'net' ? 'å›æ¨åŸå§‹è»Šè³‡' : 'å¯¦é ˜æ·¨åˆ© (ä¼°)';
            updateModalDisplay();
            
            modalOverlay.classList.remove('hidden');
            setTimeout(() => { modalOverlay.style.opacity = "1"; }, 10); // Fix fade in
            modalContent.style.transform = `translateY(0)`;
            document.body.style.overflow = 'hidden'; 
            vibrate(15);
        };

        window.closeModal = function() {
            modalContent.style.transform = `translateY(100%)`;
            modalOverlay.style.backgroundColor = `rgba(0, 0, 0, 0)`;
            setTimeout(() => {
                modalOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto'; 
            }, 300);
        };

        window.pressKey = function(key) {
            vibrate(5);
            if (key === 'del') {
                currentInput = currentInput.slice(0, -1);
            } else if (currentInput.length < 7) {
                currentInput += key;
            }
            updateModalDisplay();
        };

        function updateModalDisplay() {
            const val = parseFloat(currentInput) || 0;
            let result = currentTemplate ? (currentTemplate.inputType === 'net' ? Math.round(val / currentTemplate.rate) : Math.round(val * currentTemplate.rate)) : 0;
            
            // ä¿®æ”¹ï¼šå³æ™‚é¡¯ç¤ºåƒåˆ†ä½
            const formattedInput = currentInput ? parseFloat(currentInput).toLocaleString() : "0";
            document.getElementById('display-val').innerText = formattedInput;
            
            document.getElementById('m-calc-val').innerText = `$${result.toLocaleString()}`;
        }

        window.confirmEntry = function() {
            if (!currentInput || currentInput === "0") return;
            const inputVal = parseFloat(currentInput);
            let netAmount = currentTemplate.inputType === 'net' ? inputVal : Math.round(inputVal * currentTemplate.rate);
            let originalAmount = currentTemplate.inputType === 'net' ? Math.round(inputVal / currentTemplate.rate) : inputVal;

            const now = new Date();
            records.unshift({
                id: Date.now(),
                label: currentTemplate.label,
                icon: currentTemplate.icon,
                net: netAmount,
                original: originalAmount,
                date: `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`
            });

            saveData();
            closeModal();
            vibrate([10, 30, 10]);
        };

        window.deleteRecord = function(id, event) {
            if (event) event.stopPropagation(); 
            records = records.filter(r => r.id !== id);
            saveData();
            vibrate(20);
        };

        window.clearHistory = function() {
            records = [];
            saveData();
            vibrate([50, 50, 50]);
        };

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            updateUI();
        }

        function updateUI() {
            const totalNet = records.reduce((sum, r) => sum + r.net, 0);
            const count = records.length;
            const avg = count > 0 ? Math.round(totalNet / count) : 0;

            document.getElementById('total-net').innerText = `$${totalNet.toLocaleString()}`;
            document.getElementById('stat-total').innerText = `$${totalNet.toLocaleString()}`;
            document.getElementById('stat-trips').innerText = count;
            document.getElementById('stat-avg').innerText = `$${avg.toLocaleString()}`;

            const listContainer = document.getElementById('record-list');
            if (records.length === 0) {
                listContainer.innerHTML = `<div class="h-40 flex flex-col items-center justify-center text-slate-700 opacity-40"><i class="fas fa-box-open text-4xl mb-3"></i><p class="text-xs font-bold uppercase tracking-widest">ç›®å‰æš«ç„¡è¡Œç¨‹</p></div>`;
            } else {
                // åˆ—è¡¨æ–‡å­—èˆ‡åœ–ç¤ºä¹ŸåŠ å¤§
                listContainer.innerHTML = records.map(r => `
                    <div class="flex items-center gap-4 p-5 bg-slate-800/30 rounded-[1.5rem] border border-white/5 active:bg-slate-800 transition-all">
                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center shrink-0 bg-slate-900 shadow-inner text-2xl">${r.icon}</div>
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-slate-200 truncate text-lg">${r.label}</p>
                            <div class="flex items-center gap-2 mt-1"><span class="text-[11px] text-slate-500 font-bold font-mono">${r.date}</span><span class="text-[11px] font-bold text-slate-400">åŸå§‹: <span class="font-mono">$${r.original.toLocaleString()}</span></span></div>
                        </div>
                        <div class="text-right shrink-0 pr-1"><p class="font-black font-mono text-xl text-green-400">$${r.net.toLocaleString()}</p></div>
                        <button onclick="window.deleteRecord(${r.id}, event)" class="w-12 h-12 flex items-center justify-center text-slate-600 active:text-red-400 text-lg"><i class="fas fa-trash-can"></i></button>
                    </div>`).join('');
            }
        }
        function vibrate(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }
        init();
    </script>
</body>
</html>
